# PII Detection Testing Guide

Kompletny przewodnik po testach detekcji PII w Vigil Guard v1.6.

## PrzeglƒÖd

System test√≥w PII wykorzystuje 3 pliki testowe pokrywajƒÖce r√≥≈ºne scenariusze:

1. **pii-detection-comprehensive.test.js** (NOWY) - **57 payloads** z fixtures, pe≈Çne pokrycie miƒôdzynarodowe
2. **pii-detection-presidio.test.js** - Happy path Presidio (10 test√≥w)
3. **pii-detection-fallback.test.js** - Fallback do regex (12 test√≥w)

### Pokrycie miƒôdzynarodowe (57 payloads):

- **Polish PII** (5 payloads): PESEL, NIP, REGON, ID_CARD
- **International PII** (30 payloads):
  - **US**: SSN, Phone, Address, Driver's License
  - **UK**: NHS Number, National Insurance, Phone, Address, Passport, IBAN
  - **Canada**: SIN (Social Insurance Number)
  - **Australia**: Medicare Number, Tax File Number
  - **Europe**: IBAN (DE, FR, GB, PL)
  - **Global**: EMAIL, PHONE, CREDIT_CARD, IP, URL, PERSON, LOCATION, DATE_TIME
- **Invalid PII** (11 payloads): Invalid checksums (PESEL, NIP, US SSN, UK NHS, IBAN), benign numbers
- **Edge Cases** (8 payloads): Empty, unicode, encoding, long text
- **Performance Tests** (3 payloads): Latency benchmarks

## Wymagania Wstƒôpne

### 1. Uruchom wszystkie us≈Çugi

```bash
cd /Users/tomaszbartel/Documents/Projects/Vigil-Guard

# Upewnij siƒô ≈ºe wszystkie kontenery dzia≈ÇajƒÖ
docker-compose ps

# Je≈õli nie dzia≈ÇajƒÖ, uruchom:
docker-compose up -d
```

### 2. Zweryfikuj status Presidio

```bash
# Sprawd≈∫ czy Presidio jest zdrowy
curl http://localhost:5001/health

# Powinno zwr√≥ciƒá:
# {"status":"healthy","recognizers_loaded":4,"spacy_models":["en","pl"]}
```

### 3. Sprawd≈∫ n8n workflow

1. Otw√≥rz http://localhost:5678
2. Zaimportuj workflow: `services/workflow/workflows/Vigil-Guard-v1.6.json`
3. Aktywuj workflow
4. Sprawd≈∫ czy webhook endpoint dzia≈Ça:

```bash
curl -X POST http://localhost:5678/webhook/42f773e2-7ebf-42f7-a993-8be016d218e1 \
  -H "Content-Type: application/json" \
  -d '{"chatInput":"test"}'
```

### 4. Ustaw zmiennƒÖ ≈õrodowiskowƒÖ ClickHouse

```bash
# Export has≈Ça z .env
export CLICKHOUSE_PASSWORD=$(grep CLICKHOUSE_PASSWORD .env | cut -d '=' -f2)

# Zweryfikuj po≈ÇƒÖczenie
curl -u admin:$CLICKHOUSE_PASSWORD http://localhost:8123/ping
```

## Uruchamianie Test√≥w

### Test 1: Comprehensive Suite (ZALECANY - pe≈Çne pokrycie)

```bash
cd services/workflow

# Uruchom wszystkie 35 payloads + 3 summary testy
npm test e2e/pii-detection-comprehensive.test.js

# Tylko wybrane grupy:
npm test e2e/pii-detection-comprehensive.test.js -t "Valid Polish PII"
npm test e2e/pii-detection-comprehensive.test.js -t "Valid International PII"
npm test e2e/pii-detection-comprehensive.test.js -t "Invalid PII"
npm test e2e/pii-detection-comprehensive.test.js -t "Edge Cases"
npm test e2e/pii-detection-comprehensive.test.js -t "Performance Tests"
npm test e2e/pii-detection-comprehensive.test.js -t "Detection Rate Summary"
```

### Test 2: Presidio Happy Path

```bash
# Wymaga dzia≈ÇajƒÖcego Presidio
npm test e2e/pii-detection-presidio.test.js
```

### Test 3: Regex Fallback

```bash
# Najlepiej z zatrzymanym Presidio (test fallback):
docker stop vigil-presidio-pii

npm test e2e/pii-detection-fallback.test.js

# Uruchom ponownie Presidio:
docker start vigil-presidio-pii
```

### Uruchom WSZYSTKIE testy PII na raz

```bash
npm test -- --grep "PII Detection"
```

## Oczekiwane Wyniki

### Comprehensive Suite (57 payloads)

```
‚úÖ Valid Polish PII Detection (5 payloads)
   - PESEL_valid_checksum          ‚Üí DETECTED
   - NIP_formatted                 ‚Üí DETECTED
   - REGON_9_digits                ‚Üí DETECTED
   - ID_card_formatted             ‚Üí DETECTED
   - Mixed_Polish_PII              ‚Üí DETECTED (3+ entities)

‚úÖ Valid International PII Detection (30 payloads)
   üìß Email & Communication:
   - Email_simple                  ‚Üí DETECTED
   - Email_complex                 ‚Üí DETECTED
   - Phone_international           ‚Üí DETECTED
   - US_Phone_formats              ‚Üí DETECTED
   - UK_Phone_format               ‚Üí DETECTED

   üí≥ Financial:
   - Credit_card_Visa              ‚Üí DETECTED
   - Credit_card_bare              ‚Üí DETECTED
   - IBAN_PL, IBAN_DE, IBAN_GB, IBAN_FR ‚Üí DETECTED

   üÜî Government IDs:
   - US_SSN_formatted, US_SSN_bare ‚Üí DETECTED
   - UK_NHS_number                 ‚Üí DETECTED
   - UK_NI_number                  ‚Üí DETECTED
   - CA_SIN_formatted              ‚Üí DETECTED
   - AU_Medicare_number            ‚Üí DETECTED
   - AU_TFN_number                 ‚Üí DETECTED
   - Passport_number               ‚Üí DETECTED
   - Driver_License_US             ‚Üí DETECTED

   üåê Network & Location:
   - IP_address_v4, IP_address_v6  ‚Üí DETECTED
   - URL_http                      ‚Üí DETECTED
   - Address_US, Address_UK        ‚Üí MAY FAIL (NLP-based)

   üë§ Personal:
   - Person_name_context           ‚Üí MAY FAIL (NLP-based, low confidence)
   - Person_name_English           ‚Üí MAY FAIL (NLP-based)
   - Date_of_Birth                 ‚Üí DETECTED
   - Multiple_international_PII    ‚Üí DETECTED (5+ entities)

‚úÖ Invalid PII - Should NOT Detect (11 payloads)
   Polish:
   - PESEL_invalid_checksum        ‚Üí NOT DETECTED ‚úÖ
   - NIP_invalid_checksum          ‚Üí NOT DETECTED ‚úÖ

   International:
   - US_SSN_invalid_format         ‚Üí NOT DETECTED ‚úÖ
   - UK_NHS_invalid_checksum       ‚Üí NOT DETECTED ‚úÖ
   - IBAN_invalid_checksum         ‚Üí NOT DETECTED ‚úÖ
   - Email_malformed               ‚Üí NOT DETECTED ‚úÖ
   - Phone_too_short               ‚Üí NOT DETECTED ‚úÖ
   - Credit_card_Luhn_fail         ‚Üí NOT DETECTED ‚úÖ

   Benign Numbers:
   - Order_number                  ‚Üí NOT DETECTED ‚úÖ
   - Date_as_digits                ‚Üí NOT DETECTED ‚úÖ
   - Product_code                  ‚Üí NOT DETECTED ‚úÖ

‚úÖ Edge Cases (8 payloads)
   - Empty_string                  ‚Üí Processed without error
   - Whitespace_only               ‚Üí Processed without error
   - Multiple_spaces               ‚Üí DETECTED (email)
   - Mixed_languages               ‚Üí DETECTED (3 entities)
   - Unicode_characters            ‚Üí DETECTED (Polish chars)
   - HTML_encoded                  ‚Üí MAY NOT DETECT
   - Base64_encoded                ‚Üí NOT DETECTED (as expected)
   - Very_long_text                ‚Üí DETECTED (PESEL at end)

‚úÖ Performance Tests (3 payloads)
   - Single_email_minimal          ‚Üí < 2000ms e2e
   - Ten_emails                    ‚Üí < 2000ms e2e
   - Mixed_PII_10_types            ‚Üí < 2000ms e2e

üìä Detection Rate Summary
   - Valid PII detection rate:     ‚â• 95%
   - False positive rate:          < 10%
   - Primary method:               presidio (when healthy)
```

## Interpretacja Wynik√≥w

### ‚úÖ SUKCES (Expected)

- **Detected 95%+ valid PII**: Presidio + regex poprawnie wykrywajƒÖ dane osobowe
- **False positive rate <10%**: Ma≈Ço b≈Çƒôdnych detekcji (order numbers, dates)
- **Latency <2000ms**: Wydajno≈õƒá jest akceptowalna
- **detection_method='presidio'**: U≈ºywany jest Presidio (gdy zdrowy)

### ‚ö†Ô∏è OSTRZE≈ªENIA (Acceptable)

- **PERSON detection failure**: Detekcja imion/nazwisk wymaga NLP, mo≈ºe mieƒá niskƒÖ pewno≈õƒá
- **HTML/Base64 not detected**: Enkodowane dane nie sƒÖ wykrywane (by design)
- **1-2 false positives**: Order numbers czasem wykrywane jako PESEL (tolerowane <10%)

### ‚ùå B≈ÅƒòDY (Action Required)

- **Detection rate <90%**: Presidio mo≈ºe byƒá offline lub modele nie za≈Çadowane
  - RozwiƒÖzanie: `./scripts/init-presidio.sh`
- **False positive rate >15%**: Checksum validation nie dzia≈Ça
  - RozwiƒÖzanie: Sprawd≈∫ custom recognizers w `presidio-pii-api/recognizers/`
- **Latency >3000ms**: Problem z wydajno≈õciƒÖ
  - RozwiƒÖzanie: Sprawd≈∫ `docker stats vigil-presidio-pii`

## Struktura Fixtures

Plik `tests/fixtures/pii-test-payloads.json`:

```json
{
  "valid_pii": {
    "polish": [5 payloads],          // PESEL, NIP, REGON, ID_CARD
    "international": [30 payloads]   // US SSN, UK NHS/NINO, CA SIN, AU Medicare/TFN,
                                     // EMAIL, PHONE, CARD, IBAN (PL/DE/GB/FR),
                                     // IP, URL, PERSON, LOCATION, DATE_TIME,
                                     // Passport, Driver License
  },
  "invalid_pii": {
    "false_formats": [8 payloads],   // Invalid checksums (PL, US, UK, IBAN)
    "benign_numbers": [3 payloads]   // Order numbers, dates, SKUs
  },
  "edge_cases": [8 payloads],        // Empty, unicode, encoding, long text
  "performance_tests": [3 payloads], // Latency benchmarks
  "metadata": {
    "version": "1.6.0",
    "total_payloads": 57,
    "international_coverage": {
      "US": ["SSN", "Phone", "Address", "Driver_License"],
      "UK": ["NHS", "NINO", "Phone", "Address", "Passport", "IBAN"],
      "Canada": ["SIN"],
      "Australia": ["Medicare", "TFN"],
      "Europe": ["IBAN_DE", "IBAN_FR", "IBAN_GB", "IBAN_PL"],
      "Poland": ["PESEL", "NIP", "REGON", "ID_CARD"],
      "Global": ["EMAIL", "PHONE", "CREDIT_CARD", "IP", "URL", "PERSON", "LOCATION", "DATE_TIME"]
    }
  }
}
```

## Troubleshooting

### Problem: "Presidio service is offline"

```bash
# Sprawd≈∫ czy kontener dzia≈Ça
docker ps | grep vigil-presidio-pii

# Je≈õli nie dzia≈Ça, uruchom:
docker-compose up -d presidio-pii-api

# Sprawd≈∫ logi:
docker logs vigil-presidio-pii

# Zainicjalizuj Presidio:
./scripts/init-presidio.sh
```

### Problem: "Event not found in ClickHouse"

```bash
# Sprawd≈∫ czy ClickHouse dzia≈Ça
curl -u admin:$CLICKHOUSE_PASSWORD http://localhost:8123/ping

# Sprawd≈∫ logi n8n:
docker logs vigil-n8n | tail -20

# Zweryfikuj czy workflow jest aktywny:
# http://localhost:5678 ‚Üí Check workflow status
```

### Problem: "Webhook request failed: HTTP 404"

```bash
# Sprawd≈∫ webhook ID w tests/helpers/webhook.js
cat tests/helpers/webhook.js | grep WEBHOOK_URL

# Zaimportuj workflow na nowo:
# http://localhost:5678 ‚Üí Import ‚Üí Vigil-Guard-v1.6.json

# Sprawd≈∫ nowy webhook ID w workflow ‚Üí Settings ‚Üí Webhook URL
```

### Problem: "PERSON entities not detected"

To jest normalne. Detekcja PERSON wymaga:
- spaCy NLP models (en_core_web_sm, pl_core_news_sm)
- Kontekst jƒôzykowy (czasowniki, przyimki)
- Wy≈ºsza pewno≈õƒá (confidence >0.5)

RozwiƒÖzania:
1. Dodaj wiƒôcej kontekstu: "Spotka≈Çem siƒô z Jan Kowalski wczoraj"
2. Obni≈º threshold w `unified_config.json`: `"score_threshold": 0.3`
3. Zaakceptuj jako known limitation (NLP-based detection)

## Metryki Sukcesu

Test suite jest uznawany za PASSED je≈õli:

- ‚úÖ Detection rate ‚â• 95% (valid PII)
- ‚úÖ False positive rate < 10% (invalid PII)
- ‚úÖ Latency < 2000ms e2e (performance tests)
- ‚úÖ Presidio used as primary method (when healthy)
- ‚úÖ Fallback to regex works (when Presidio offline)
- ‚úÖ All edge cases handled without crashes

## Dodatkowe Testy Manualne

### Test 1: Manual redaction check

```bash
curl -X POST http://localhost:5678/webhook/42f773e2-7ebf-42f7-a993-8be016d218e1 \
  -H "Content-Type: application/json" \
  -d '{"chatInput":"Jan Kowalski, PESEL: 92032100157, email: jan@example.com"}' | jq
```

Oczekiwany response:
```json
{
  "sessionId": "...",
  "chatInput": "[PERSON], PESEL: [PESEL], email: [EMAIL]",
  "status": "SANITIZED"
}
```

### Test 2: Check ClickHouse logging

```bash
# Sprawd≈∫ ostatnie 5 event√≥w z PII detection
clickhouse-client --password=$CLICKHOUSE_PASSWORD --query "
  SELECT
    timestamp,
    JSONExtractString(sanitizer_json, 'pii', 'detection_method') as method,
    JSONExtractInt(sanitizer_json, 'pii', 'entities_detected') as entities
  FROM n8n_logs.events_processed
  WHERE sanitizer_json LIKE '%pii%'
  ORDER BY timestamp DESC
  LIMIT 5
  FORMAT Pretty
"
```

### Test 3: Performance benchmark

```bash
# Uruchom 10 request√≥w i zmierz ≈õredni czas
for i in {1..10}; do
  time curl -s -X POST http://localhost:5678/webhook/42f773e2-7ebf-42f7-a993-8be016d218e1 \
    -H "Content-Type: application/json" \
    -d '{"chatInput":"test@example.com"}' > /dev/null
done
```

## Nastƒôpne Kroki

Po pomy≈õlnym przej≈õciu test√≥w:

1. ‚úÖ Commit zmian:
   ```bash
   git add services/workflow/tests/e2e/pii-detection-comprehensive.test.js
   git add services/workflow/tests/PII_TESTING_GUIDE.md
   git commit -m "test(pii): Add comprehensive PII detection test suite with 35 payloads"
   ```

2. üìä Uruchom testy w CI/CD (je≈õli skonfigurowane)

3. üìù Zaktualizuj dokumentacjƒô projektu (TODO.md)

4. üöÄ Deploy do ≈õrodowiska testowego

## Referencje

- **Fixtures**: `tests/fixtures/pii-test-payloads.json`
- **Webhook helpers**: `tests/helpers/webhook.js`
- **Presidio API**: http://localhost:5001/docs
- **n8n workflow**: http://localhost:5678
- **ClickHouse**: http://localhost:8123
- **Vigil Guard docs**: `/docs/PII_DETECTION.md`
